<?php

use Drupal\Component\Utility\String;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_FORM_ID_alter() for user_form().
 */
function password_policy_form_user_form_alter(&$form, &$form_state) {
	/**
	 * Use cases:
	 * -Add User - how do we know which role? this should come first with an AJAX on change
	 */
	//dpm($form);
	//$form['#validate'][] = 'user_restrictions_validate';

	//dpq($form_state);

	//user interface changes
	//TODO - Consider hiding Password Strength indicator and Password Recommendations
	$form['account']['roles']['#weight'] = '0';
	$form['account']['mail']['#weight'] = '1';
	$form['account']['name']['#weight'] = '2';
	$form['account']['status']['#weight'] = '5';
	$form['account']['notify']['#weight'] = '6';

	//update password field
	$form['account']['pass']['#title'] = 'Password';
	//TODO - Removing password confirm (does not have any AJAX call) causes error on AJAX
	$form['account']['pass']['#type'] = 'password';
	$form['account']['pass']['#weight'] = '3';

	$form['account']['password_policy_status'] = array(
		'#title' => 'Password policies',
		'#type' => 'table',
		'#header' => array(t('Status'), t('Constraint')),
		'#empty' => t('There are no constraints for the selected user roles'),
		'#weight' => '4',
		'#prefix' => '<div id="password-policy-status">',
		'#suffix' => '</div>',
		'#rows' => _password_policy_constraints_table($form, $form_state),
	);

	//set ajax changes
	$form['account']['roles']['#ajax'] = array(
		'event' => 'change',
		'callback' => '_password_policy_check_constraints',
		'method' => 'replace',
		'wrapper' => 'password-policy-status',
	);

	$form['account']['pass']['#ajax'] = array(
		'event' => 'change',
		'callback' => '_password_policy_check_constraints',
		'method' => 'replace',
		'wrapper' => 'password-policy-status',
	);
}

/**
 * AJAX callback for user form
 */
function _password_policy_check_constraints($form, $form_state) {
	return $form['account']['password_policy_status'];
}

/**
 * AJAX callback for user form
 */
function _password_policy_constraints_table($form, $form_state) {

	//$plugin_manager = \Drupal::service('plugin.manager.password_policy.password_constraint');
	//$user_constraints = $plugin_manager->getDefinitions();
	//dpm($plugins);

	$roles = $form_state->getValue('roles');

	//add user doesn't automatically register authenticated, so lets add it
	if(empty($roles)){
		$roles = array('authenticated'=>'1');
	}

	//only load these once time for performance
	$plugin_manager = \Drupal::service('plugin.manager.password_policy.password_constraint');
	$plugin_manager->getDefinitions();

	//get constraints for selected roles
	$user_constraints = array();
	foreach ($roles as $role_key=>$role_selected){
		if ($role_selected !== '0') {
			$role_constraints = _password_policy_get_constraints_by_role($role_key, $plugin_manager);
			$user_constraints = array_merge($user_constraints, $role_constraints);
		}
	}

	//dpm($user_constraints);

	//verify and display password for constraints
	$table_rows = array();
	foreach($user_constraints as $constraint){
		//TODO - Need to evaluate config parameters here
		$table_row = array('constraint' => $constraint['description']);
		$constraint_inst = \Drupal::service('plugin.manager.password_policy.password_constraint')->createInstance($constraint['id']);
		if(!$constraint_inst->validate($form_state->getValue('pass'))){
			$table_row['status'] = 'Fail';
		} else {
			$table_row['status'] = 'Pass';
		}
		$table_rows[] = $table_row;
	}

	//if no role, show default message
	return $table_rows;
}

/**
 * Load the plugins for a role
 */
function _password_policy_get_constraints_by_role($role_key, $plugin_manager) {
	$role = \Drupal\user\Entity\Role::load($role_key);
	$role_constraints = array();

	$all_plugins = $plugin_manager->getDefinitions();
	foreach($all_plugins as $plugin) {
		if ($role->hasPermission('enforce ' . $plugin->id . ' constraint')) {
			$role_constraints[] = $plugin;
		}
	}

	return $role_constraints;
}

/**
 * Submit handler for policies
 */
function _password_policy_register_policy() {
	//save policy
}